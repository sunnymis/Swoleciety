///////////////////
///
/// An example of how to resolve data in your routes
/// with AngularFire. 
///
/// Author: @eastdotnet
/// Date: 7/18/2014
///
////////////////////

angular.module('plunker', ['ngRoute', 'firebase'])

.constant('FBURL', 'https://firenode.firebaseio.com/')

.service('FbRef', ['FBURL', Firebase])

.config(['$routeProvider',
  function($routeProvider) {
    
    // Set up our routes
    $routeProvider
      
      .when('/', {
        templateUrl: 'home.html',
        controller: 'HomeCtrl',
      })
      
      // this is where we resolve our user data
      .when('/resolve', {
        templateUrl: 'resolve.html',
        controller: 'ResolveCtrl',
        resolve: {
          // this will be available in the Ctrl
          data: function(Auth) {
           // getCurrentUser returns a promise, but
           // angular is smart and will resolve it for us
           // and make the actual data available in the Ctrl
           return Auth.getCurrentUser();
          }
        }
      })
      
      .otherwise({
        redirectTo: '/'
      });
  }
])

.controller('HomeCtrl', function($scope, Auth, $window) {
  
  $scope.user = {
    email: 'bob@email.com',
    password: 'password'
  };
  
  $scope.login = function() {
    
    // when logged in go to the resolve page
    Auth.login('password', $scope.user)
      .then(function() {
        $window.location.href = '#/resolve';
      });
    
  };
  
})

// In the resolve page we have our user data available on
// the constructor
.controller('ResolveCtrl', function($scope, data) {
  
  // No loading in the Ctrl!
  $scope.user = data;
  
})

// Little Fascade wrapper around $firebaseSimpleLogin
// Provides a resuable and easily injectable way to
// use $firebaseSimpleLogin
.factory('Auth', function($firebaseSimpleLogin, FbRef, $rootScope) {
  var simpleLogin = $firebaseSimpleLogin(FbRef);
  return {
    getCurrentUser: function() {
      return simpleLogin.$getCurrentUser();
    },
    login: function(provider, user) {
      return simpleLogin.$login(provider, {
        email: user.email,
        password: user.password
      });
    },
    logout: function() {
      simpleLogin.$logout();
    },
    onLogin: function(cb) {
      $rootScope.$on('$firebaseSimpleLogin:login',
        function(e, user) {
          cb(e, user);
        });
    },
    onLogout: function(cb) {
      $rootScope.$on('$firebaseSimpleLogin:logout',
        function(e, user) {
          cb(e, user);
        });
    },
    onError: function(cb) {
      $rootScope.$on('$firebaseSimpleLogin:error',
        function(e, user) {
          cb(e, user);
        });
    }
  }
});